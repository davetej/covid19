from airflow import settings
from airflow.models import DagModel, DagTag
from airflow.api.client.local_client import Client

# Function to assign a role to a DAG
def assign_role_to_dag(dag_id, role_name):
    client = Client(api_base_url=settings.API_BASE_URL)
    client.dag_role.add_role(dag_id=dag_id, role_name=role_name)

# Function to get DAGs with specific tags
def get_dags_with_tags(tags):
    dag_ids = []
    for tag in tags:
        dag_ids.extend([dag.dag_id for dag in DagModel.get_dags() if tag in DagTag.get_tag(dag.dag_id)])
    return dag_ids

# Main function
def main():
    # Define the role and tags
    role_name = 'View'
    tags_to_assign = ['TagA']

    # Get DAGs with specific tags
    dags_to_assign = get_dags_with_tags(tags_to_assign)

    # Assign role to the identified DAGs
    for dag_id in dags_to_assign:
        assign_role_to_dag(dag_id, role_name)
        print(f"Assigned {role_name} role to DAG {dag_id}")

if __name__ == '__main__':
    main()
