from airflow.plugins_manager import AirflowPlugin
from airflow.www.security import AirflowSecurityManager
from airflow.www.views import Airflow
from flask import session
from airflow.models import DagBag

class CustomSecurityManager(AirflowSecurityManager):

    def get_user_dags(self):
        # Get the logged-in user
        user = self.get_user_by_id(session['_user_id'])
        username = user.username

        # Load all DAGs
        dag_bag = DagBag()
        
        # Filter DAGs based on the owner or a specific tag
        filtered_dags = {
            dag_id: dag for dag_id, dag in dag_bag.dags.items()
            if dag.owner == username or 'your_tag' in dag.tags
        }
        return filtered_dags

    def get_accessible_dags(self, user):
        return self.get_user_dags()

class CustomDAGFilterPlugin(AirflowPlugin):
    name = "custom_dag_filter_plugin"
    security_manager_class = CustomSecurityManager
